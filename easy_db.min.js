/*! EasyDB v0.0.1 by Chris Hall
 * Packaged on 2013-08-07
 * License: CC-BY-SA
 * https://github.com/chall8908/easy_db
 */
function EasyDB(a){this.settings=a||this.testSettings,this.open().openDatabase()}function TransactionWrapper(a,b){this.databaseKey=a,this.databaseSettings=b}EasyDB.prototype.testSettings={connection:["easy_db",1],schema:[{name:"sample_table",keyPath:"id",indexes:[["by_id","id",{unique:!0}]]}]},EasyDB.prototype.delete=function(){indexedDB.deleteDatabase.apply(indexedDB,this.settings.connection)},EasyDB.prototype.open=function(a){return new TransactionWrapper(a,this.settings)},EasyDB.prototype.get=EasyDB.prototype.open,EasyDB.prototype.clear=function(a){new TransactionWrapper(a,this.settings).clear()},TransactionWrapper.prototype.openConnection=function(){var a=indexedDB.open.apply(indexedDB,this.databaseSettings),b=new $.Deferred,c=this.databaseSettings.schema;return a.onupgradeneeded=function(a){var b=a.target.result;$.each(c,function(a,c){var d;try{b.deleteObjectStore(c.name)}catch(e){}d=b.createObjectStore(c.name,c.settings),_.each(c.indexes,function(a){d.createIndex.apply(d,a)})})},a.onsuccess=function(a){b.resolve(a.target.result)},a.onerror=this.handleError(b),b},TransactionWrapper.prototype.handleError=function(a){if(a.resolve&&a.reject){var b=this;return function(c){b.handleError(c),a.reject(c)}}console.error(e)},TransactionWrapper.prototype.getObjectStore=function(a,b){var c=this.databaseKey,d=a.transaction(c,b||"readonly");return d.objectStore(c)},TransactionWrapper.prototype.all=function(){var a=new $.Deferred,b=this;return b.openConnection().then(function(c){var d=[],e=(b.getObjectStore(c),store.openCursor());e.onsuccess=function(b){var c=b.target.result;return c?(d.push(c.value),c.continue(),void 0):(a.resolve(d),void 0)},e.onerror=b.handleError(a)}),a},TransactionWrapper.prototype.by=function(a,b){var c=new $.Deferred,d=this;return d.openConnection().then(function(e){var f=[],g=d.getObjectStore(e),h=g.index(a),i=h.get(b);i.onsuccess=function(a){var b=a.target.result;return b?(f.push(b.value),b.continue(),void 0):(c.resolve(f),void 0)},i.onerror=d.handleError(c)}),c},TransactionWrapper.prototype.limit=function(a,b,c){var d=new $.Deferred,e=this;if(b||(b=0),c)switch(c.toLowerCase()){case"asc":c="prev";break;case"desc":c="next"}else c="next";return e.openConnection().then(function(f){var g=[],h=e.getObjectStore(f),i=h.openCursor(null,c);i.onsuccess=function(c){var e=c.target.result;return e&&g.length!=a?(0===b?g.push(e.value):b--,e.continue(),void 0):(d.resolve(g),void 0)},i.onerror=handleError(d)}),d},TransactionWrapper.prototype.where=function(a){var b=new $.Deferred,c=this;return c.openConnection().then(function(d){var e=[],f=c.getObjectStore(d),g=f.openCursor();g.onsuccess=function(c){var d=c.target.result;return d?(e=_.union(_.where([d.value],a)),d.continue(),void 0):(b.resolve(e),void 0)},g.onerror=handleError(b)}),b},TransactionWrapper.prototype.insert=function(a,b){var c=this;a instanceof Array||(a=[a]),c.openConnection().then(function(d){try{var e=c.getObjectStore(d,"readwrite");_.each(a,function(a){var d=b?e.put(a):e.add(a);d.onerror=c.handleError})}catch(f){console.error(f),console.log("Key used: "+key),console.log("Data not stored: \n"+JSON.stringify(a,null,2)),console.trace()}})},TransactionWrapper.prototype.update=function(a){this.insert(a,!0)},TransactionWrapper.prototype.clear=function(){var a=this;a.openConnection().then(function(b){var c=a.getObjectStore(b,"readwrite");c.clear()})};